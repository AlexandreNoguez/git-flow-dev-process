name: Create GitHub Release from tag and CHANGELOG

on:
  push:
    tags:
      - "v*.*.*" # dispara apenas para tags oficiais, ex: v1.4.0, v2.0.1

jobs:
  create_release:
    runs-on: ubuntu-latest

    permissions:
      contents: write # necessário para ler o repo; não vamos commitar nada aqui

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # garante histórico e tags completos

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Aqui NÃO rodamos npm ci / npm run changelog
      # porque o CHANGELOG.md já foi atualizado pelo Tech Lead antes da tag

      - name: Extract changelog section for this tag
        id: extract_changelog
        run: |
                TAG_NAME="${GITHUB_REF_NAME}"  # ex: v1.0.9
                VERSION="${TAG_NAME#v}"        # remove o "v", fica 1.0.9

                echo "TAG_NAME=${TAG_NAME}"
                echo "VERSION=${VERSION}"

                if [ ! -f "CHANGELOG.md" ]; then
                  echo "CHANGELOG.md not found!"
                  exit 1
                fi

                export VERSION

                SECTION=$(python - << 'EOF'
                import os, re, json, sys

                version = os.environ["VERSION"]  # e.g. "1.0.9"

                try:
                    with open("CHANGELOG.md", encoding="utf-8") as f:
                        text = f.read()
                except FileNotFoundError:
                    print("CHANGELOG.md not found", file=sys.stderr)
                    sys.exit(1)

                # Vamos dividir o arquivo em blocos:
                # [preâmbulo], (heading, body), (heading, body), ...
                # Onde heading é algo tipo: "## [1.0.9](...) (2025-12-10)"
                parts = re.split(r'(^##[^\n]*$)', text, flags=re.M)

                section_text = None

                if len(parts) > 1:
                    # parts[0] é o preâmbulo; depois vem pares (heading, body)
                    for i in range(1, len(parts), 2):
                        heading = parts[i].strip()
                        body = parts[i+1]

                        # Queremos um heading que contenha exatamente "[1.0.9]"
                        token = f"[{version}]"
                        if token in heading:
                            section_text = heading + body
                            break

                if not section_text:
                    print(f"No changelog section found for version {version}", file=sys.stderr)
                    sys.exit(1)

                # Salva pra debug
                with open("CHANGELOG_SECTION.md", "w", encoding="utf-8") as f:
                    f.write(section_text)

                print("=== Extracted section ===")
                print(section_text)
                print("=== End of section ===")

                # Escapa o texto em JSON pra enviar como output
                print(json.dumps(section_text))
                EOF
                )

                if [ -z "$SECTION" ]; then
                  echo "Empty changelog section; failing."
                  exit 1
                fi

                echo "section=${SECTION}" >> "$GITHUB_OUTPUT"


      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }} # ex: v1.4.0
          name: ${{ github.ref_name }} # nome da release (pode customizar)
          body: ${{ fromJson(steps.extract_changelog.outputs.section) }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
