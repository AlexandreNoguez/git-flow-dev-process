name: Create GitHub Release from tag + CHANGELOG

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*.*-rc.*"

jobs:
  create_release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Get version from tag
        id: vars
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"   # ex: refs/tags/v1.1.0 -> v1.1.0
          TAG_NAME="${TAG_NAME#refs/tags/}"
          VERSION="${TAG_NAME#v}"         # 1.1.0 ou 1.1.0-rc.1

          echo "Tag: $TAG_NAME"
          echo "Version: $VERSION"

          echo "tag=$TAG_NAME"       >> "$GITHUB_OUTPUT"
          echo "version=$VERSION"    >> "$GITHUB_OUTPUT"

          if [[ "$TAG_NAME" == *"-rc."* ]]; then
            echo "prerelease=true"  >> "$GITHUB_OUTPUT"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Extract notes from CHANGELOG
        run: |
          node scripts/extract-notes.mjs "${{ steps.vars.outputs.version }}" > RELEASE_NOTES.md
          echo "==== Release notes ===="
          cat RELEASE_NOTES.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: ${{ steps.vars.outputs.tag }}
          body_path: RELEASE_NOTES.md
          prerelease: ${{ steps.vars.outputs.prerelease }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
