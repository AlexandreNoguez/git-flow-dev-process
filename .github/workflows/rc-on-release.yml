name: RC Tag from releases

on:
  push:
    branches:
      - "releases/**"
    paths-ignore:
      - "CHANGELOG.md"
      - ".tmp/**"

jobs:
  tag-rc:
    concurrency:
      group: rc-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Guard (somente em releases/*)
        shell: bash
        run: |
          case "${GITHUB_REF_NAME}" in
            releases/*) echo "OK: ${GITHUB_REF_NAME}";;
            *) echo "Este workflow só deve rodar em releases/*"; exit 1;;
          esac

      - name: Ler versão base do package.json
        id: ver
        shell: bash
        run: |
          BASE=$(node -p "require('./package.json').version")
          echo "base=${BASE}" >> $GITHUB_OUTPUT

      - name: Calcular próximo RC
        id: rc
        shell: bash
        run: |
          set -eo pipefail
          BASE="${{ steps.ver.outputs.base }}"
          TAGS="$(git tag -l "v${BASE}-rc.[0-9]*" || true)"
          if [ -z "$TAGS" ]; then LAST=0
          else LAST="$(printf '%s\n' "$TAGS" | sed -E 's/.*-rc\.([0-9]+)$/\1/' | sort -n | tail -1)"; fi
          NEXT=$((LAST + 1))
          echo "tag=v${BASE}-rc.${NEXT}" >> $GITHUB_OUTPUT

      - name: Criar tag RC
        shell: bash
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.rc.outputs.tag }}" -m "RC ${{ steps.rc.outputs.tag }} a partir de ${GITHUB_REF_NAME}"
          git push origin "${{ steps.rc.outputs.tag }}"
