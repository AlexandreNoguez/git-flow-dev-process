name: RC Tag from releases
on:
  push:
    branches:
      - "releases/**"

jobs:
  tag-rc:
    concurrency:
      group: rc-${{ github.ref }}
      cancel-in-progress: false
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Guard (somente em releases/*)
        run: |
          case "${GITHUB_REF_NAME}" in
            releases/*) echo "OK: ${GITHUB_REF_NAME}";;
            *) echo "Este workflow só deve rodar em releases/*"; exit 1;;
          esac

      - name: Ler versão base do package.json
        id: ver
        run: |
          BASE=$(node -p "require('./package.json').version")
          echo "base=${BASE}" >> $GITHUB_OUTPUT
          echo "Versão base: ${BASE}"

      - name: Calcular próximo RC
        id: rc
        run: |
          set -euo pipefail
          BASE="${{ steps.ver.outputs.base }}"
          LAST=$(git tag -l "v${BASE}-rc.*" | sort -V | tail -1)
          if [ -z "${LAST}" ]; then NEXT=1; else NEXT=$((LAST+1)); fi
          TAG="v${BASE}-rc.${NEXT}"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Próxima RC: ${TAG}"

      # ↓↓↓ GERAR NOTAS A PARTIR DOS COMMITS (entre a última tag e o HEAD)
      - name: Gerar notas para a tag (Conventional Commits)
        id: notes
        run: |
          mkdir -p .tmp
          # Gera notas APENAS desde a última tag (r=1)
          npx -y conventional-changelog-cli -p angular -r 1 > .tmp/TAG_NOTES.md
          echo "preview:"
          head -n 30 .tmp/TAG_NOTES.md || true

      # ↓↓↓ CRIAR A TAG ANOTADA USANDO AS NOTAS GERADAS
      - name: Criar tag RC (anotada com notas)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ steps.rc.outputs.tag }}" -F .tmp/TAG_NOTES.md
          git push origin "${{ steps.rc.outputs.tag }}"

      # (Opcional) Atualizar CHANGELOG.md incremental
      - name: Atualizar CHANGELOG (incremental)
        run: |
          npx -y conventional-changelog-cli -p angular -i CHANGELOG.md -s
          git add CHANGELOG.md
          git commit -m "chore(changelog): update for ${{ steps.rc.outputs.tag }}" || true
          git push origin HEAD:${GITHUB_REF_NAME}
